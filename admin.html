<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';">
    <title>SafeVault - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .header { background: #16213e; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header h1 { color: #e94560; font-size: 24px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .user-badge { background: #0f3460; padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #e94560; color: white; }
        .btn-primary:hover { background: #d63850; }
        .btn-secondary { background: #0f3460; color: white; }
        .btn-secondary:hover { background: #1a4a7a; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .container { padding: 30px; max-width: 1400px; margin: 0 auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #16213e; padding: 25px; border-radius: 10px; text-align: center; }
        .stat-card h3 { color: #aaa; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; }
        .stat-card .value { font-size: 36px; font-weight: bold; color: #e94560; }
        .stat-card .sub { font-size: 12px; color: #888; margin-top: 5px; }
        .section { background: #16213e; border-radius: 10px; padding: 25px; margin-bottom: 25px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section h2 { color: #e94560; font-size: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #0f3460; border: none; border-radius: 4px; color: #aaa; cursor: pointer; transition: all 0.3s; }
        .tab.active { background: #e94560; color: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #2a2a4a; }
        th { background: #0f3460; color: #e94560; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        tr:hover { background: #1f1f3a; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-admin { background: #e94560; color: white; }
        .badge-user { background: #0f3460; color: #aaa; }
        .badge-valid { background: #28a745; color: white; }
        .badge-invalid { background: #ffc107; color: #333; }
        .badge-blocked { background: #dc3545; color: white; }
        .badge-active { background: #28a745; color: white; }
        .badge-inactive { background: #6c757d; color: white; }
        .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 20px; }
        .pagination button { padding: 8px 12px; background: #0f3460; border: none; color: #aaa; cursor: pointer; border-radius: 4px; }
        .pagination button.active { background: #e94560; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal.show { display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #16213e; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; }
        .modal-content h3 { color: #e94560; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #aaa; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; background: #0f3460; border: 1px solid #2a2a4a; border-radius: 4px; color: white; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .loading { text-align: center; padding: 50px; color: #aaa; }
        .error-message { background: #dc354533; border: 1px solid #dc3545; padding: 15px; border-radius: 4px; color: #ff6b6b; margin-bottom: 20px; }
        .access-denied { text-align: center; padding: 100px 20px; }
        .access-denied h2 { color: #dc3545; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="accessDenied" class="access-denied" style="display: none;">
    <h2>â›” ì ‘ê·¼ ê±°ë¶€</h2>
    <p>ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
    <button class="btn btn-primary" onclick="window.location.href='/'">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<div id="mainContent" style="display: none;">
    <header class="header">
        <h1>ğŸ›¡ï¸ SafeVault Admin</h1>
        <div class="header-right">
            <span class="user-badge">ğŸ‘¤ <span id="adminUsername"></span></span>
            <button class="btn btn-secondary" onclick="window.location.href='/'">ğŸ  í™ˆ</button>
            <button class="btn btn-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </header>

    <div class="container">
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>ì „ì²´ ì‚¬ìš©ì</h3>
                <div class="value" id="statTotalUsers">-</div>
                <div class="sub">í™œì„±: <span id="statActiveUsers">-</span></div>
            </div>
            <div class="stat-card">
                <h3>ê²€ì¦ ë¡œê·¸</h3>
                <div class="value" id="statTotalLogs">-</div>
                <div class="sub">ì˜¤ëŠ˜: <span id="statTodayLogs">-</span></div>
            </div>
            <div class="stat-card">
                <h3>ì°¨ë‹¨ëœ ì‹œë„</h3>
                <div class="value" id="statBlockedAttempts">-</div>
                <div class="sub">ìœ„í˜‘ íƒì§€</div>
            </div>
            <div class="stat-card">
                <h3>ì°¨ë‹¨ íŒ¨í„´</h3>
                <div class="value" id="statTotalPatterns">-</div>
                <div class="sub">í™œì„±: <span id="statActivePatterns">-</span></div>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
            <button class="tab active" data-tab="users">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
            <button class="tab" data-tab="logs">ğŸ“‹ ê²€ì¦ ë¡œê·¸</button>
            <button class="tab" data-tab="patterns">ğŸš« ì°¨ë‹¨ íŒ¨í„´</button>
        </div>

        <!-- ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ -->
        <div id="usersSection" class="section">
            <div class="section-header">
                <h2>ì‚¬ìš©ì ëª©ë¡</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì‚¬ìš©ìëª…</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ì—­í• </th>
                        <th>ìƒíƒœ</th>
                        <th>ê°€ì…ì¼</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr><td colspan="7" class="loading">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
            <div class="pagination" id="usersPagination"></div>
        </div>

        <!-- ê²€ì¦ ë¡œê·¸ ì„¹ì…˜ -->
        <div id="logsSection" class="section" style="display: none;">
            <div class="section-header">
                <h2>ê²€ì¦ ë¡œê·¸</h2>
                <select id="logFilter" onchange="loadLogs(1)">
                    <option value="">ì „ì²´</option>
                    <option value="VALID">ìœ íš¨</option>
                    <option value="INVALID">ë¬´íš¨</option>
                    <option value="BLOCKED">ì°¨ë‹¨ë¨</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ìœ í˜•</th>
                        <th>ê²°ê³¼</th>
                        <th>ìœ„í˜‘ ìœ í˜•</th>
                        <th>IP</th>
                        <th>ì‹œê°„</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    <tr><td colspan="6" class="loading">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
            <div class="pagination" id="logsPagination"></div>
        </div>

        <!-- ì°¨ë‹¨ íŒ¨í„´ ì„¹ì…˜ -->
        <div id="patternsSection" class="section" style="display: none;">
            <div class="section-header">
                <h2>ì°¨ë‹¨ íŒ¨í„´</h2>
                <button class="btn btn-success" onclick="showAddPatternModal()">+ íŒ¨í„´ ì¶”ê°€</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>íŒ¨í„´</th>
                        <th>ìœ í˜•</th>
                        <th>ì„¤ëª…</th>
                        <th>ìƒíƒœ</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="patternsTableBody">
                    <tr><td colspan="6" class="loading">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- íŒ¨í„´ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="addPatternModal" class="modal">
    <div class="modal-content">
        <h3>ìƒˆ ì°¨ë‹¨ íŒ¨í„´ ì¶”ê°€</h3>
        <div class="form-group">
            <label>íŒ¨í„´ (ì •ê·œì‹)</label>
            <input type="text" id="patternInput" placeholder="ì˜ˆ: <script.*?>">
        </div>
        <div class="form-group">
            <label>ìœ í˜•</label>
            <select id="patternType">
                <option value="0">SQL_INJECTION</option>
                <option value="1">XSS</option>
                <option value="2">PATH_TRAVERSAL</option>
                <option value="3">COMMAND_INJECTION</option>
                <option value="4">OTHER</option>
            </select>
        </div>
        <div class="form-group">
            <label>ì„¤ëª…</label>
            <textarea id="patternDescription" placeholder="ì´ íŒ¨í„´ì— ëŒ€í•œ ì„¤ëª…"></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModal('addPatternModal')">ì·¨ì†Œ</button>
            <button class="btn btn-success" onclick="addPattern()">ì¶”ê°€</button>
        </div>
    </div>
</div>

<script>
const API_BASE = '/api';
let currentUserPage = 1;
let currentLogPage = 1;

// ì¸ì¦ ê´€ë¦¬
const AuthManager = {
    token: localStorage.getItem('authToken'),
    user: JSON.parse(localStorage.getItem('authUser') || 'null'),
    
    isLoggedIn: function() { return !!this.token && !!this.user; },
    isAdmin: function() { return this.user && this.user.role === 'Admin'; },
    
    getHeaders: function() {
        return {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + this.token
        };
    },
    
    clearAuth: function() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('authUser');
    }
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ê¶Œí•œ í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
    if (!AuthManager.isLoggedIn() || !AuthManager.isAdmin()) {
        document.getElementById('accessDenied').style.display = 'block';
        return;
    }
    
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('adminUsername').textContent = AuthManager.user.username;
    
    loadDashboard();
    loadUsers(1);
    
    // íƒ­ ì „í™˜
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            document.getElementById('usersSection').style.display = 'none';
            document.getElementById('logsSection').style.display = 'none';
            document.getElementById('patternsSection').style.display = 'none';
            
            const tabName = this.dataset.tab;
            document.getElementById(tabName + 'Section').style.display = 'block';
            
            if (tabName === 'users') loadUsers(1);
            else if (tabName === 'logs') loadLogs(1);
            else if (tabName === 'patterns') loadPatterns();
        });
    });
});

async function fetchApi(url, options = {}) {
    try {
        const response = await fetch(API_BASE + url, {
            ...options,
            headers: AuthManager.getHeaders()
        });
        
        if (response.status === 401) {
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            logout();
            return null;
        }
        
        return await response.json();
    } catch (error) {
        console.error('API Error:', error);
        return null;
    }
}

async function loadDashboard() {
    const stats = await fetchApi('/admin/dashboard');
    if (stats) {
        document.getElementById('statTotalUsers').textContent = stats.totalUsers;
        document.getElementById('statActiveUsers').textContent = stats.activeUsers;
        document.getElementById('statTotalLogs').textContent = stats.totalValidationLogs;
        document.getElementById('statBlockedAttempts').textContent = stats.blockedAttempts;
        document.getElementById('statTotalPatterns').textContent = stats.totalBlockedPatterns;
        document.getElementById('statActivePatterns').textContent = stats.activeBlockedPatterns;
    }
}

async function loadUsers(page) {
    currentUserPage = page;
    const data = await fetchApi(`/admin/users?page=${page}&pageSize=10`);
    if (!data) return;
    
    const tbody = document.getElementById('usersTableBody');
    if (data.users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="loading">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.users.map(user => `
        <tr>
            <td>${user.userId}</td>
            <td>${escapeHtml(user.username)}</td>
            <td>${escapeHtml(user.email)}</td>
            <td><span class="badge ${user.role === 'Admin' ? 'badge-admin' : 'badge-user'}">${user.role}</span></td>
            <td><span class="badge badge-active">í™œì„±</span></td>
            <td>${new Date(user.createdAt).toLocaleDateString('ko-KR')}</td>
            <td>
                <button class="btn btn-secondary" onclick="toggleRole(${user.userId}, '${user.role}')">ì—­í•  ë³€ê²½</button>
                <button class="btn btn-danger" onclick="deleteUser(${user.userId})">ì‚­ì œ</button>
            </td>
        </tr>
    `).join('');
    
    renderPagination('usersPagination', data.totalCount, data.pageSize, page, loadUsers);
}

async function loadLogs(page) {
    currentLogPage = page;
    const filter = document.getElementById('logFilter').value;
    const data = await fetchApi(`/admin/logs?page=${page}&pageSize=20&filter=${filter}`);
    if (!data) return;
    
    const tbody = document.getElementById('logsTableBody');
    if (data.logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.logs.map(log => `
        <tr>
            <td>${log.logId}</td>
            <td>${escapeHtml(log.inputType)}</td>
            <td><span class="badge badge-${log.validationResult.toLowerCase()}">${log.validationResult}</span></td>
            <td>${log.threatType || '-'}</td>
            <td>${log.ipAddress || '-'}</td>
            <td>${new Date(log.createdAt).toLocaleString('ko-KR')}</td>
        </tr>
    `).join('');
    
    renderPagination('logsPagination', data.totalCount, data.pageSize, page, loadLogs);
}

async function loadPatterns() {
    const patterns = await fetchApi('/admin/patterns');
    if (!patterns) return;
    
    const tbody = document.getElementById('patternsTableBody');
    if (patterns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">íŒ¨í„´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }
    
    const patternTypes = ['SQL_INJECTION', 'XSS', 'PATH_TRAVERSAL', 'COMMAND_INJECTION', 'OTHER'];
    
    tbody.innerHTML = patterns.map(p => `
        <tr>
            <td>${p.patternId}</td>
            <td><code>${escapeHtml(p.pattern)}</code></td>
            <td>${patternTypes[p.patternType] || p.patternType}</td>
            <td>${escapeHtml(p.description || '-')}</td>
            <td><span class="badge ${p.isActive ? 'badge-active' : 'badge-inactive'}">${p.isActive ? 'í™œì„±' : 'ë¹„í™œì„±'}</span></td>
            <td>
                <button class="btn btn-secondary" onclick="togglePattern(${p.patternId})">${p.isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}</button>
                <button class="btn btn-danger" onclick="deletePattern(${p.patternId})">ì‚­ì œ</button>
            </td>
        </tr>
    `).join('');
}

async function toggleRole(userId, currentRole) {
    const newRole = currentRole === 'Admin' ? 'User' : 'Admin';
    if (!confirm(`ì—­í• ì„ ${newRole}(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    const result = await fetchApi(`/admin/users/${userId}/role`, {
        method: 'PUT',
        body: JSON.stringify({ userId, newRole })
    });
    
    if (result) loadUsers(currentUserPage);
}

async function deleteUser(userId) {
    if (!confirm('ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await fetchApi(`/admin/users/${userId}`, { method: 'DELETE' });
    loadUsers(currentUserPage);
    loadDashboard();
}

async function togglePattern(patternId) {
    await fetchApi(`/admin/patterns/${patternId}/toggle`, { method: 'PUT' });
    loadPatterns();
    loadDashboard();
}

async function deletePattern(patternId) {
    if (!confirm('ì´ íŒ¨í„´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    await fetchApi(`/admin/patterns/${patternId}`, { method: 'DELETE' });
    loadPatterns();
    loadDashboard();
}

function showAddPatternModal() {
    document.getElementById('addPatternModal').classList.add('show');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

async function addPattern() {
    const pattern = document.getElementById('patternInput').value;
    const patternType = parseInt(document.getElementById('patternType').value);
    const description = document.getElementById('patternDescription').value;
    
    if (!pattern) {
        alert('íŒ¨í„´ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const result = await fetchApi('/admin/patterns', {
        method: 'POST',
        body: JSON.stringify({ pattern, patternType, description })
    });
    
    if (result) {
        closeModal('addPatternModal');
        document.getElementById('patternInput').value = '';
        document.getElementById('patternDescription').value = '';
        loadPatterns();
        loadDashboard();
    }
}

function renderPagination(containerId, total, pageSize, current, callback) {
    const container = document.getElementById(containerId);
    const totalPages = Math.ceil(total / pageSize);
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '';
    for (let i = 1; i <= totalPages; i++) {
        html += `<button class="${i === current ? 'active' : ''}" onclick="${callback.name}(${i})">${i}</button>`;
    }
    container.innerHTML = html;
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function logout() {
    AuthManager.clearAuth();
    window.location.href = '/';
}
</script>
</body>
</html>
